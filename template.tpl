___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Reddit Conversion API",
  "categories": [
    "ADVERTISING",
    "ANALYTICS",
    "CONVERSIONS",
    "MARKETING",
    "REMARKETING"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "stape.io",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Tag that send the event data from the GA4/Data Clients to Reddit Conversion API.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "configGroup",
    "subParams": [
      {
        "type": "RADIO",
        "name": "eventType",
        "displayName": "Event Name Setup Method",
        "radioItems": [
          {
            "value": "standard",
            "displayValue": "Standard",
            "subParams": [
              {
                "type": "SELECT",
                "name": "eventName",
                "macrosInSelect": false,
                "selectItems": [
                  {
                    "value": "PAGE_VISIT",
                    "displayValue": "Page Visit"
                  },
                  {
                    "value": "VIEW_CONTENT",
                    "displayValue": "View Content"
                  },
                  {
                    "value": "SEARCH",
                    "displayValue": "Search"
                  },
                  {
                    "value": "ADD_TO_CART",
                    "displayValue": "Add To Cart"
                  },
                  {
                    "value": "ADD_TO_WISHLIST",
                    "displayValue": "Add To Wishlist"
                  },
                  {
                    "value": "PURCHASE",
                    "displayValue": "Purchase"
                  },
                  {
                    "value": "LEAD",
                    "displayValue": "Lead"
                  },
                  {
                    "value": "SIGN_UP",
                    "displayValue": "Sign Up"
                  }
                ],
                "simpleValueType": true,
                "alwaysInSummary": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ],
                "displayName": "Event Name",
                "defaultValue": "PAGE_VISIT"
              }
            ]
          },
          {
            "value": "inherit",
            "subParams": [],
            "displayValue": "Inherit from client"
          },
          {
            "value": "custom",
            "subParams": [
              {
                "type": "TEXT",
                "name": "eventNameCustom",
                "displayName": "Event Name",
                "simpleValueType": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              }
            ],
            "displayValue": "Custom"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "standard"
      },
      {
        "type": "TEXT",
        "name": "accountId",
        "displayName": "Pixel ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": "The ID of the pixel (data source) on your Reddit Ads account. It can be found in the \u003ca href\u003d\"https://ads.reddit.com/events-manager\"\u003eEvents Manager\u003c/a\u003e.",
        "valueHint": "t2_***** or a2_*****"
      },
      {
        "type": "TEXT",
        "name": "accessToken",
        "displayName": "Conversion Access Token",
        "simpleValueType": true,
        "help": "A conversion access token is a non-expiring secure key that lets you send conversion event data. \u003ca href\u003d\"https://business.reddithelp.com/s/article/conversion-access-token\" target\u003d\"_blank\"\u003eLearn more\u003c/a\u003e.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "testId",
        "displayName": "Test ID",
        "simpleValueType": true,
        "help": "A unique identifier for test events intended for the \u003ca href\u003d\"https://ads.reddit.com/events-manager/testing\"\u003eEvent Testing tool\u003c/a\u003e. This should be set to the value given in the Event Testing instructions."
      },
      {
        "type": "CHECKBOX",
        "name": "useOptimisticScenario",
        "checkboxText": "Use Optimistic Scenario",
        "simpleValueType": true,
        "help": "The tag will call gtmOnSuccess() without waiting for a response from the API. This will speed up sGTM response time however your tag will always return the status fired successfully even in case it is not."
      }
    ]
  },
  {
    "displayName": "Common Event Data Override",
    "name": "commonEventDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "TEXT",
        "name": "eventAt",
        "displayName": "Event At",
        "simpleValueType": true,
        "help": "The Unix epoch in \u003cb\u003emilliseconds\u003c/b\u003e timestamp when the conversion event occurred."
      },
      {
        "type": "TEXT",
        "name": "clickId",
        "displayName": "Click ID",
        "simpleValueType": true,
        "help": "The Reddit-generated id associated with a single ad click."
      }
    ]
  },
  {
    "displayName": "Server Event Data Override",
    "name": "serverEventDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "name": "serverEventDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "value",
            "displayName": "Property Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "conversion_id",
                "displayValue": "Conversion ID"
              },
              {
                "value": "currency",
                "displayValue": "Currency"
              },
              {
                "value": "item_count",
                "displayValue": "Item Count"
              },
              {
                "value": "products",
                "displayValue": "Products"
              },
              {
                "value": "value",
                "displayValue": "Value"
              },
              {
                "value": "value_decimal",
                "displayValue": "Value Decimal (deprecated, use Value instead)"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property",
        "help": "Make sure your input is formatted accordingly to the \u003ca href\u003d\"https://ads-api.reddit.com/docs/v3/operations/Post%20Conversion%20Events\"\u003e Official Documentation\u003c/a\u003e.\n\u003cbr/\u003e\n\u003cul\u003e \n\u003cli\u003e\u003cb\u003eConversion ID (string): \u003c/b\u003eThe unique conversion ID that corresponds to a distinct conversion event. (E.g. \u0027OID12345\u0027)\u003c/li\u003e\n \u003cli\u003e\u003cb\u003eCurrency (string): Three-character ISO 4217 code. \u003c/b\u003e (E.g. \u0027\u0027USD\u0027,\u0027CAD\u0027,etc)\u003c/li\u003e\n \u003cli\u003e\u003cb\u003eItem Count (integer): The number of items in the event. \u003c/b\u003e (E.g. 5)\u003c/li\u003e \n\u003cli\u003e\u003cb\u003eValue (number/double): \u003c/b\u003e The value of the transaction.\u003c/br\u003e (E.g. \u0027123.99\u0027)\u003c/li\u003e \n\u003cli\u003e\u003cb\u003eProducts (product[]): \u003c/b\u003e Array of product objects.\u003c/br\u003e (E.g. \u0027[ {category:\"food utensils\", id:\"ABC123\", name: \"large pasta bowl\" }, ... ]\u0027)\u003c/li\u003e \n\u003c/ul\u003e",
        "displayName": "Help"
      }
    ]
  },
  {
    "displayName": "User Data",
    "name": "userDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "name": "userDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "email",
            "displayName": "Property Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "email",
                "displayValue": "Email"
              },
              {
                "value": "phone_number",
                "displayValue": "Phone Number"
              },
              {
                "value": "external_id",
                "displayValue": "External ID"
              },
              {
                "value": "idfa",
                "displayValue": "iOS IDFA"
              },
              {
                "value": "aaid",
                "displayValue": "Android GAID/AAID"
              },
              {
                "value": "ip_address",
                "displayValue": "IP address"
              },
              {
                "value": "user_agent",
                "displayValue": "User Agent"
              },
              {
                "value": "screen_dimensions",
                "displayValue": "Screen Dimensions"
              },
              {
                "value": "uuid",
                "displayValue": "UUID (_rdt_uuid first party cookie)"
              },
              {
                "value": "opt_out",
                "displayValue": "Opt Out (deprecated, use Data Processing Options instead)"
              },
              {
                "value": "data_processing_options.country",
                "displayValue": "Data Processing Options Country"
              },
              {
                "value": "data_processing_options.region",
                "displayValue": "Data Processing Options Region"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property",
        "help": "Make sure your input is formatted accordingly to the \u003ca href\u003d\"https://ads-api.reddit.com/docs/v3/operations/Post%20Conversion%20Events\"\u003e Official Documentation\u003c/a\u003e.\n\u003c/br\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cb\u003ePhone Number (string): \u003c/b\u003e E.164 format (E.g. \u0027+55981556677\u0027)\u003c/li\u003e\n\u003cli\u003e \u003cb\u003eEmail (string): Plain Text \u003c/b\u003e (E.g. \u0027test@test.com\u0027)\u003c/li\u003e\n\u003cli\u003e \u003cb\u003eExternal ID (string): Plain Text \u003c/b\u003e (E.g. \u00277c73f2ae-a433-4d7b-9838-f467da98f48e\u0027)\u003c/li\u003e\n\u003cli\u003e\u003cb\u003eIP Adress (string): \u003c/b\u003e The IP address of the user. \u003c/br\u003e (E.g. \u0027192.0.2.1\u0027)\u003c/li\u003e\n\u003cli\u003e\u003cb\u003eUser Agent (string): \u003c/b\u003e The user agent of the user\u0027s browser. \u003c/br\u003e (E.g. \u0027Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0\u0027)\u003c/li\u003e\n\u003cli\u003e\u003cb\u003eAAID (string): \u003c/b\u003eThe Android Advertising ID (AAID) of the user\u0027s Android device.\u003c/br\u003e (E.g. \u0027cdda802e-fb9c-47ad-9866-0794d394c912\u0027)\u003c/li\u003e\n\u003cli\u003e\u003cb\u003eIDFA (string): \u003c/b\u003e The Identifier for Advertisers (IDFA) of the user\u0027s Apple device \u003c/br\u003e (E.g. \u0027EA7583CD-A667-48BC-B806-42ECB2B48606\u0027)\u003c/li\u003e\n\u003cli\u003e\u003cb\u003eUUID (string): \u003c/b\u003e The value from the first-party Pixel \u003ci\u003e_rdt_uuid\u003c/i\u003e cookie on your domain \u003c/br\u003e (E.g. \u00271684189007728.7c73f2ae-a433-4d7b-9838-f467da98f48e\u0027;\n)\u003c/li\u003e\n\u003c/ul\u003e",
        "displayName": "Help"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "tagExecutionConsentSettingsGroup",
    "displayName": "Tag Execution Consent Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "adStorageConsent",
        "displayName": "",
        "radioItems": [
          {
            "value": "optional",
            "displayValue": "Send data always"
          },
          {
            "value": "required",
            "displayValue": "Send data in case marketing consent given",
            "help": "Aborts the tag execution if marketing consent (\u003ci\u003ead_storage\u003c/i\u003e Google Consent Mode or Stape\u0027s Data Tag parameter) is not given."
          }
        ],
        "simpleValueType": true,
        "defaultValue": "optional"
      }
    ]
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  },
  {
    "displayName": "BigQuery Logs Settings",
    "name": "bigQueryLogsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "bigQueryLogType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log to BigQuery"
          },
          {
            "value": "always",
            "displayValue": "Log to BigQuery"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "no"
      },
      {
        "type": "GROUP",
        "name": "logsBigQueryConfigGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "logBigQueryProjectId",
            "displayName": "BigQuery Project ID",
            "simpleValueType": true,
            "help": "Optional.  \u003cbr\u003e\u003cbr\u003e  If omitted, it will be retrieved from the environment variable \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e where the server container is running. If the server container is running on Google Cloud, \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e will already be set to the Google Cloud project\u0027s ID."
          },
          {
            "type": "TEXT",
            "name": "logBigQueryDatasetId",
            "displayName": "BigQuery Dataset ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "logBigQueryTableId",
            "displayName": "BigQuery Table ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "bigQueryLogType",
            "paramValue": "always",
            "type": "EQUALS"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const getAllEventData = require('getAllEventData');
const JSON = require('JSON');
const sendHttpRequest = require('sendHttpRequest');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const getContainerVersion = require('getContainerVersion');
const getEventData = require('getEventData');
const logToConsole = require('logToConsole');
const getRequestHeader = require('getRequestHeader');
const parseUrl = require('parseUrl');
const decodeUriComponent = require('decodeUriComponent');
const getType = require('getType');
const getTimestampMillis = require('getTimestampMillis');
const makeNumber = require('makeNumber');
const makeString = require('makeString');
const makeInteger = require('makeInteger');
const encodeUriComponent = require('encodeUriComponent');
const createRegex = require('createRegex');
const testRegex = require('testRegex');
const BigQuery = require('BigQuery');
const computeEffectiveTldPlusOne = require('computeEffectiveTldPlusOne');

/*==============================================================================
==============================================================================*/

const eventData = getAllEventData();

if (!isConsentGivenOrNotRequired(data, eventData)) {
  return data.gtmOnSuccess();
}

const url = getUrl(eventData);
if (url && url.lastIndexOf('https://gtm-msr.appspot.com/', 0) === 0) {
  return data.gtmOnSuccess();
}

const deprecatedCookie = getCookieValues('rdt_cid')[0];
let rdtcid = deprecatedCookie || getCookieValues('_rdt_cid')[0] || eventData.rdt_cid;
handleRedditCookie(url);

const apiVersion = '3';
const postUrl = 'https://ads-api.reddit.com/api/v' + apiVersion + '/pixels/' + enc(data.accountId) + '/conversion_events';
const postBody = mapEvent(eventData, data);
sendRedditRequest(postUrl, postBody);

if (data.useOptimisticScenario) {
  return data.gtmOnSuccess();
}

/*==============================================================================
  Vendor related functions
==============================================================================*/

function sendRedditRequest(postUrl, postBody) {
  const eventType = postBody.data.events[0].type;
  const eventName = eventType.tracking_type === 'CUSTOM' ? eventType.custom_event_name : eventType.tracking_type;

  log({
    Name: 'Reddit',
    Type: 'Request',
    EventName: eventName,
    RequestMethod: 'POST',
    RequestUrl: postUrl,
    RequestBody: postBody
  });

  sendHttpRequest(
    postUrl,
    (statusCode, headers, body) => {
      log({
        Name: 'Reddit',
        Type: 'Response',
        EventName: eventName,
        ResponseStatusCode: statusCode,
        ResponseHeaders: headers,
        ResponseBody: body
      });

      if (!data.useOptimisticScenario) {
        if (statusCode >= 200 && statusCode < 400) {
          data.gtmOnSuccess();
        } else {
          data.gtmOnFailure();
        }
      }
    },
    {
      headers: {
        'Content-Type': 'application/json',
        Authorization: 'Bearer ' + data.accessToken
      },
      method: 'POST'
    },
    JSON.stringify(postBody)
  );
}

function handleRedditCookie(url) {
  if (deprecatedCookie) {
    setCookie('rdt_cid', '', {
      domain: getCookieAutoDomain(),
      path: '/',
      samesite: 'Lax',
      secure: true,
      'max-age': 0,
      httpOnly: false
    });
  }

  if (url) {
    const urlParsed = parseUrl(url);

    if (urlParsed && urlParsed.searchParams.rdt_cid) {
      rdtcid = decodeUriComponent(urlParsed.searchParams.rdt_cid);
    }
  }

  if (rdtcid) {
    setCookie('_rdt_cid', rdtcid, {
      domain: getCookieAutoDomain(),
      path: '/',
      samesite: 'Lax',
      secure: true,
      'max-age': 2592000, // 30 days
      httpOnly: false
    });
  }
}

function mapEvent(eventData, data) {
  let mappedData = {
    type: getEventType(eventData, data),
    event_at: getTimestampMillis(),
    action_source: 'WEBSITE',
    metadata: {},
    user: {}
  };

  const eventAt = data.eventAt;
  if (eventAt) {
    const timestampMillisRegex = createRegex('^[0-9]+$');
    // Retrocompatibility v2 -> v3
    mappedData.event_at = testRegex(timestampMillisRegex, makeString(eventAt)) ? makeInteger(eventAt) : convertISOToTimeMs(eventAt);
  }

  if (data.clickId) {
    mappedData.click_id = data.clickId;
  } else if (rdtcid) {
    mappedData.click_id = rdtcid;
  }

  mappedData = addUserData(eventData, mappedData);
  mappedData = addPropertiesData(eventData, mappedData);

  return {
    data: {
      test_id: data.testId,
      events: [mappedData]
    }
  };
}

function addPropertiesData(eventData, mappedData) {
  if (eventData.event_id) mappedData.metadata.conversion_id = makeString(eventData.event_id);
  else if (eventData.transaction_id) mappedData.metadata.conversion_id = makeString(eventData.transaction_id);

  if (eventData.currency) mappedData.metadata.currency = eventData.currency;
  if (eventData.item_count) mappedData.metadata.item_count = eventData.item_count;

  if (isValidValue(eventData.value)) mappedData.metadata.value = makeNumber(eventData.value);
  else if (isValidValue(eventData['x-ga-mp1-ev'])) mappedData.metadata.value = makeNumber(eventData['x-ga-mp1-ev']);
  else if (isValidValue(eventData['x-ga-mp1-tr'])) mappedData.metadata.value = makeNumber(eventData['x-ga-mp1-tr']);

  if (eventData.products) mappedData.metadata.products = eventData.products;
  else if (eventData.items && eventData.items[0]) {
    mappedData.metadata.products = [];

    eventData.items.forEach((product) => {
      let item = {};

      if (product.item_id) item.id = makeString(product.item_id);
      else if (product.id) item.id = makeString(product.id);

      if (product.content_category) item.category = product.content_category;
      else if (product.category) item.category = product.category;
      else if (product.item_category) item.category = product.item_category;

      if (product.content_name) item.name = product.content_name;
      else if (product.name) item.name = product.name;
      else if (product.item_name) item.name = product.item_name;

      mappedData.metadata.products.push(item);
    });
  }

  if (data.serverEventDataList) {
    data.serverEventDataList.forEach((serverData) => {
      let name = serverData.name;
      let value = serverData.value;
      switch (serverData.name) {
        case 'value_decimal':
        case 'value':
          name = 'value'; // Retrocompatibility v2 -> v3
          value = makeNumber(value);
          break;
      }
      mappedData.metadata[name] = value;
    });
  }

  return mappedData;
}

function addUserData(eventData, mappedData) {
  const uuid = getUUIDFromCookie() || eventData.rdt_uuid;
  let userEventData = {};

  if (getType(eventData.user_data) === 'object') {
    userEventData = eventData.user_data || eventData.user_properties || eventData.user;
  }

  if (uuid) mappedData.user.uuid = uuid;

  const platform = eventData['x-ga-platform'];

  if (eventData.aaid) mappedData.user.aaid = eventData.aaid;
  else if (userEventData.aaid) mappedData.user.aaid = userEventData.aaid;
  else if (platform === 'android' && eventData['x-ga-resettable_device_id']) {
    mappedData.user.aaid = eventData['x-ga-resettable_device_id'];
  }

  if (eventData.idfa) mappedData.user.idfa = eventData.idfa;
  else if (userEventData.idfa) mappedData.user.idfa = userEventData.idfa;
  else if (platform === 'ios' && eventData['x-ga-resettable_device_id']) {
    mappedData.user.idfa = eventData['x-ga-resettable_device_id'];
  }

  if (eventData.email) mappedData.user.email = eventData.email;
  else if (eventData.email_address) mappedData.user.email = eventData.email_address;
  else if (userEventData.email) mappedData.user.email = userEventData.email;
  else if (userEventData.email_address) mappedData.user.email = userEventData.email_address;
  else if (getCookieValues('_rdt_em')[0]) mappedData.user.email = getCookieValues('_rdt_em')[0];

  if (eventData.phone) mappedData.user.phone_number = eventData.phone;
  else if (eventData.phone_number) mappedData.user.phone_number = eventData.phone_number;
  else if (userEventData.phone) mappedData.user.phone_number = userEventData.phone;
  else if (userEventData.phone_number) mappedData.user.phone_number = userEventData.phone_number;

  if (eventData.external_id) mappedData.user.external_id = eventData.external_id;
  else if (eventData.user_id) mappedData.user.external_id = eventData.user_id;
  else if (eventData.userId) mappedData.user.external_id = eventData.userId;
  else if (userEventData.external_id) mappedData.user.external_id = userEventData.external_id;

  if (eventData.ip_override) mappedData.user.ip_address = eventData.ip_override;
  else if (eventData.ip_address) mappedData.user.ip_address = eventData.ip_address;
  else if (eventData.ip) mappedData.user.ip_address = eventData.ip;

  // Retrocompatibility v2 -> v3
  if (eventData.opt_out) {
    mappedData.user.data_processing_options = {
      modes: ['LDU']
    };
  }

  if (eventData.user_agent) mappedData.user.user_agent = eventData.user_agent;

  if (eventData.viewport_size && eventData.viewport_size.split('x').length === 2) {
    mappedData.user.screen_dimensions = {
      width: makeInteger(eventData.viewport_size.split('x')[0]),
      height: makeInteger(eventData.viewport_size.split('x')[1])
    };
  } else if (eventData.height && eventData.width) {
    mappedData.user.screen_dimensions = {
      height: makeInteger(eventData.height),
      width: makeInteger(eventData.width)
    };
  }

  if (data.userDataList) {
    data.userDataList.forEach((userProperty) => {
      // Retrocompatibility v2 -> v3
      if ((userProperty.name === 'opt_out' || userProperty.name.indexOf('data_processing_options' !== -1)) && userProperty.value) {
        mappedData.user.data_processing_options = mappedData.user.data_processing_options || {
          modes: ['LDU']
        };
        if (userProperty.name === 'opt_out') return;
      }

      const names = userProperty.name.split('.');
      names.reduce((acc, name, index) => {
        const isLastKey = index === names.length - 1;
        if (isLastKey) acc[name] = userProperty.value;
        else acc[name] = acc[name] || {};
        return acc[name];
      }, mappedData.user);
    });
  }

  return mappedData;
}

function getUUIDFromCookie() {
  const uuidsWithTimestamps = getCookieValues('_rdt_uuid');
  if (!uuidsWithTimestamps || !uuidsWithTimestamps.length) return null;
  let oldest = null;
  for (let i = 0; i < uuidsWithTimestamps.length; i++) {
    const current = getUUIDAndTimestamp(uuidsWithTimestamps[i]);
    if (!current) continue;
    if (!oldest || current.timestamp < oldest.timestamp) oldest = current;
  }
  return oldest && oldest.uuid;
}

function getUUIDAndTimestamp(uuidWithTimestamp) {
  if (!uuidWithTimestamp) return null;
  const parts = uuidWithTimestamp.split('.');
  if (parts.length !== 2) return null;

  return {
    timestamp: makeNumber(parts[0]),
    uuid: makeString(parts[1])
  };
}

function getEventType(eventData, data) {
  if (data.eventType === 'inherit') {
    const eventName = eventData.event_name;

    const gaToEventName = {
      page_view: 'PAGE_VISIT',
      click: 'LEAD',
      download: 'LEAD',
      file_download: 'LEAD',
      complete_registration: 'SIGN_UP',
      'gtm.dom': 'PAGE_VISIT',
      add_payment_info: 'LEAD',
      add_to_cart: 'ADD_TO_CART',
      add_to_wishlist: 'ADD_TO_WISHLIST',
      sign_up: 'SIGN_UP',
      begin_checkout: 'LEAD',
      generate_lead: 'LEAD',
      purchase: 'PURCHASE',
      search: 'SEARCH',
      view_item: 'VIEW_CONTENT',
      contact: 'LEAD',
      find_location: 'SEARCH',
      submit_application: 'LEAD',
      subscribe: 'LEAD',

      'gtm4wp.addProductToCartEEC': 'ADD_TO_CART',
      'gtm4wp.productClickEEC': 'VIEW_CONTENT',
      'gtm4wp.checkoutOptionEEC': 'LEAD',
      'gtm4wp.checkoutStepEEC': 'LEAD',
      'gtm4wp.orderCompletedEEC': 'PURCHASE'
    };

    if (!gaToEventName[eventName]) {
      return {
        tracking_type: 'CUSTOM',
        custom_event_name: eventName
      };
    }

    return {
      tracking_type: gaToEventName[eventName]
    };
  }

  if (data.eventType === 'custom') {
    // Retrocompatibility v2 -> v3
    const retroCompatEventNameMapping = {
      Purchase: 'PURCHASE',
      SignUp: 'SIGN_UP'
    };
    if (retroCompatEventNameMapping[data.eventNameCustom]) {
      return {
        tracking_type: retroCompatEventNameMapping[data.eventNameCustom]
      };
    }

    return {
      tracking_type: 'CUSTOM',
      custom_event_name: data.eventNameCustom
    };
  }

  return {
    tracking_type: data.eventName
  };
}

/*==============================================================================
  Helpers
==============================================================================*/

function getUrl(eventData) {
  return eventData.page_location || eventData.page_referrer || getRequestHeader('referer');
}

function getCookieAutoDomain() {
  return computeEffectiveTldPlusOne(getEventData('page_location') || getRequestHeader('referer')) || 'auto';
}

function enc(data) {
  return encodeUriComponent(data || '');
}

function isValidValue(value) {
  const valueType = getType(value);
  return valueType !== 'null' && valueType !== 'undefined' && value !== '';
}

function isConsentGivenOrNotRequired(data, eventData) {
  if (data.adStorageConsent !== 'required') return true;
  if (eventData.consent_state) return !!eventData.consent_state.ad_storage;
  const xGaGcs = eventData['x-ga-gcs'] || ''; // x-ga-gcs is a string like "G110"
  return xGaGcs[2] === '1';
}

function log(rawDataToLog) {
  const logDestinationsHandlers = {};
  if (determinateIsLoggingEnabled()) logDestinationsHandlers.console = logConsole;
  if (determinateIsLoggingEnabledForBigQuery()) logDestinationsHandlers.bigQuery = logToBigQuery;

  rawDataToLog.TraceId = getRequestHeader('trace-id');

  const keyMappings = {
    // No transformation for Console is needed.
    bigQuery: {
      Name: 'tag_name',
      Type: 'type',
      TraceId: 'trace_id',
      EventName: 'event_name',
      RequestMethod: 'request_method',
      RequestUrl: 'request_url',
      RequestBody: 'request_body',
      ResponseStatusCode: 'response_status_code',
      ResponseHeaders: 'response_headers',
      ResponseBody: 'response_body'
    }
  };

  for (const logDestination in logDestinationsHandlers) {
    const handler = logDestinationsHandlers[logDestination];
    if (!handler) continue;

    const mapping = keyMappings[logDestination];
    const dataToLog = mapping ? {} : rawDataToLog;

    if (mapping) {
      for (const key in rawDataToLog) {
        const mappedKey = mapping[key] || key;
        dataToLog[mappedKey] = rawDataToLog[key];
      }
    }

    handler(dataToLog);
  }
}

function logConsole(dataToLog) {
  logToConsole(JSON.stringify(dataToLog));
}

function logToBigQuery(dataToLog) {
  const connectionInfo = {
    projectId: data.logBigQueryProjectId,
    datasetId: data.logBigQueryDatasetId,
    tableId: data.logBigQueryTableId
  };

  dataToLog.timestamp = getTimestampMillis();

  ['request_body', 'response_headers', 'response_body'].forEach((p) => {
    dataToLog[p] = JSON.stringify(dataToLog[p]);
  });

  BigQuery.insert(connectionInfo, [dataToLog], { ignoreUnknownValues: true });
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(containerVersion && (containerVersion.debugMode || containerVersion.previewMode));

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}

function determinateIsLoggingEnabledForBigQuery() {
  if (data.bigQueryLogType === 'no') return false;
  return data.bigQueryLogType === 'always';
}

function convertISOToTimeMs(dateTime) {
  const leapYear = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
  const nonLeapYear = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
  const dateArray = dateTime.split('T')[0].split('-');
  const timeArray = dateTime.split('T')[1].split(':');

  const year = makeInteger(dateArray[0]);
  const month = makeInteger(dateArray[1]);
  const day = makeInteger(dateArray[2]);
  const hour = makeInteger(timeArray[0]);
  const minutes = makeInteger(timeArray[1]);
  const seconds = makeInteger(timeArray[2]);

  let yearCounter = 1970;
  let unixTime = 0;

  while (yearCounter < year) {
    if (yearCounter % 4 === 0) {
      unixTime += 31622400;
    } else {
      unixTime += 31536000;
    }
    yearCounter++;
  }

  const monthList = yearCounter % 4 === 0 ? leapYear : nonLeapYear;

  let monthCounter = 1;
  while (monthCounter < month) {
    unixTime += monthList[monthCounter - 1] * 86400;
    monthCounter++;
  }

  let dayCounter = 1;
  while (dayCounter < day) {
    unixTime += 86400;
    dayCounter++;
  }

  let hourCounter = 0;
  while (hourCounter < hour) {
    unixTime += 3600;
    hourCounter++;
  }

  let minutesCounter = 0;
  while (minutesCounter < minutes) {
    unixTime += 60;
    minutesCounter++;
  }

  let secondsCounter = 0;
  while (secondsCounter < seconds) {
    unixTime += 1;
    secondsCounter++;
  }

  return unixTime * 1000; //milliseconds;
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "rdt_cid"
              },
              {
                "type": 1,
                "string": "_rdt_cid"
              },
              {
                "type": 1,
                "string": "_rdt_uuid"
              },
              {
                "type": 1,
                "string": "_rdt_em"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rdt_cid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_rdt_cid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://ads-api.reddit.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: '[Request] URL and Options are built and sent successfuly'
  code: "mockData.eventType = 'standard';\nconst expectedEventName = 'PageVisit';\n\
    mockData.eventName = expectedEventName;\n\nconst expectedRequestOptions = {\n\
    \  headers: {\n    'Content-Type': 'application/json',\n    Authorization: 'Bearer\
    \ ' + EXPECTED_ACCESS_TOKEN\n  },\n  method: 'POST'\n};\n\nmock('sendHttpRequest',\
    \ (requestUrl, callback, requestOptions, requestBody) => {\n  assertThat(requestUrl).isEqualTo(EXPECTED_API_URL);\n\
    \  assertThat(callback).isFunction();\n  assertThat(requestOptions).isEqualTo(expectedRequestOptions);\n\
    \  \n  callback(200);\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('gtmOnFailure').wasNotCalled();"
- name: value is correctly cast into Number when retrieved from UI
  code: |
    const expectedEventAt = 1746467516146;
    mockData.eventAt = expectedEventAt;
    mockData.eventType = 'standard';
    const expectedEventName = 'PageVisit';
    mockData.eventName = expectedEventName;

    const valueInputValue = '123';
    const expectedValue = 123;
    mockData.serverEventDataList = [{ name: 'value', value: valueInputValue }];

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const requestBodyParsed = JSON.parse(requestBody);
      assertThat(requestBodyParsed.data.events[0].metadata.value).isEqualTo(expectedValue);
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('makeNumber').wasCalledWith(valueInputValue);
- name: value_decimal is correctly cast into Number when retrieved from UI
  code: |
    const expectedEventAt = 1746467516146;
    mockData.eventAt = expectedEventAt;
    mockData.eventType = 'standard';
    const expectedEventName = 'PageVisit';
    mockData.eventName = expectedEventName;

    const valueDecimalInputValue = '123.99';
    const expectedValueDecimal = 123.99;
    mockData.serverEventDataList = [{ name: 'value_decimal', value: valueDecimalInputValue }];

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const requestBodyParsed = JSON.parse(requestBody);
      assertThat(requestBodyParsed.data.events[0].metadata.value).isEqualTo(expectedValueDecimal);
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('makeNumber').wasCalledWith(valueDecimalInputValue);
- name: value_decimal is correctly cast into Number when retrieved from Event Data
  code: |
    const expectedValueDecimal = 123.99;
    mock('getAllEventData', {
      value: expectedValueDecimal
    });

    const expectedEventAt = 1746467516146;
    mockData.eventAt = expectedEventAt;
    mockData.eventType = 'standard';
    const expectedEventName = 'PageVisit';
    mockData.eventName = expectedEventName;

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const requestBodyParsed = JSON.parse(requestBody);
      assertThat(requestBodyParsed.data.events[0].metadata.value).isEqualTo(expectedValueDecimal);
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('makeNumber').wasCalledWith(expectedValueDecimal);
- name: Click ID cookie is successfully retrieved from deprecated cookie and sent
    in the request payload
  code: |-
    const expectedEventAt = 1746467516146;
    mockData.eventAt = expectedEventAt;
    mockData.eventType = 'standard';
    const expectedEventName = 'PageVisit';
    mockData.eventName = expectedEventName;

    const expectedClickId = 'expectedClickIdDeprecatedCookie';
    mock('getCookieValues', (cookieName) => {
      if (cookieName === 'rdt_cid') return [expectedClickId];
      return [];
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const requestBodyParsed = JSON.parse(requestBody);
      assertThat(requestBodyParsed.data.events[0].click_id).isEqualTo(expectedClickId);
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: Click ID cookie is successfully retrieved from new cookie and sent in the
    request payload
  code: |-
    const expectedEventAt = 1746467516146;
    mockData.eventAt = expectedEventAt;
    mockData.eventType = 'standard';
    const expectedEventName = 'PageVisit';
    mockData.eventName = expectedEventName;

    const expectedClickId = 'expectedClickIdNewCookie';
    mock('getCookieValues', (cookieName) => {
      if (cookieName === '_rdt_cid') return [expectedClickId];
      return [];
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const requestBodyParsed = JSON.parse(requestBody);
      assertThat(requestBodyParsed.data.events[0].click_id).isEqualTo(expectedClickId);
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: Click ID cookie is successfully retrieved from Event Data and sent in the
    request payload
  code: |-
    const expectedEventAt = 1746467516146;
    mockData.eventAt = expectedEventAt;
    mockData.eventType = 'standard';
    const expectedEventName = 'PageVisit';
    mockData.eventName = expectedEventName;

    const expectedClickId = 'expectedClickIdEventData';
    mock('getAllEventData',{
      rdt_cid: expectedClickId
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const requestBodyParsed = JSON.parse(requestBody);
      assertThat(requestBodyParsed.data.events[0].click_id).isEqualTo(expectedClickId);
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: Click ID cookie is successfully retrieved from URL parameter and sent in the
    request payload
  code: |-
    const expectedEventAt = 1746467516146;
    mockData.eventAt = expectedEventAt;
    mockData.eventType = 'standard';
    const expectedEventName = 'PageVisit';
    mockData.eventName = expectedEventName;

    const expectedClickId = 'expectedClickIdEventData';
    mock('getAllEventData',{
      page_location: 'https://example.com/?rdt_cid=' + expectedClickId
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const requestBodyParsed = JSON.parse(requestBody);
      assertThat(requestBodyParsed.data.events[0].click_id).isEqualTo(expectedClickId);
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: Click ID cookie is successfully retrieved from Data and sent in the request
    payload
  code: |-
    const expectedEventAt = 1746467516146;
    mockData.eventAt = expectedEventAt;
    mockData.eventType = 'standard';
    const expectedEventName = 'PageVisit';
    mockData.eventName = expectedEventName;

    const expectedClickId = 'expectedClickIdData';
    mockData.clickId = expectedClickId;

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const requestBodyParsed = JSON.parse(requestBody);
      assertThat(requestBodyParsed.data.events[0].click_id).isEqualTo(expectedClickId);
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: Screen Dimensions are successfully retrieved from Event Data screen_dimensions
    and cast to integer
  code: |-
    const expectedEventAt = 1746467516146;
    mockData.eventAt = expectedEventAt;
    mockData.eventType = 'standard';
    const expectedEventName = 'PageVisit';
    mockData.eventName = expectedEventName;

    const expectedScreenDimensions = { width: 111, height: 222 };
    mock('getAllEventData', {
      viewport_size: expectedScreenDimensions.width + 'x' + expectedScreenDimensions.height
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const requestBodyParsed = JSON.parse(requestBody);
      assertThat(requestBodyParsed.data.events[0].user.screen_dimensions).isEqualTo({ width: expectedScreenDimensions.width, height: expectedScreenDimensions.height });
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: Screen Dimensions are successfully retrieved from Event Data width/height
    and cast to integer
  code: |-
    const expectedEventAt = 1746467516146;
    mockData.eventAt = expectedEventAt;
    mockData.eventType = 'standard';
    const expectedEventName = 'PageVisit';
    mockData.eventName = expectedEventName;

    const expectedScreenDimensions = { width: 111, height: 222 };
    mock('getAllEventData', {
      width: expectedScreenDimensions.width,
      height: expectedScreenDimensions.height
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody) => {
      const requestBodyParsed = JSON.parse(requestBody);
      assertThat(requestBodyParsed.data.events[0].user.screen_dimensions).isEqualTo({ width: expectedScreenDimensions.width, height: expectedScreenDimensions.height });
      callback(200);
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
setup: "const JSON = require('JSON');\nconst Promise = require('Promise');\n\nconst\
  \ EXPECTED_PIXEL_ID = 'expectedPixelId';\nconst EXPECTED_ACCESS_TOKEN = 'expectedAccessToken';\n\
  const EXPECTED_API_VERSION = '3';\nconst EXPECTED_API_URL = 'https://ads-api.reddit.com/api/v'\
  \ + EXPECTED_API_VERSION + '/pixels/' + EXPECTED_PIXEL_ID + '/conversion_events';\n\
  \nconst mockData = {\n  accountId: EXPECTED_PIXEL_ID,\n  accessToken: EXPECTED_ACCESS_TOKEN\n\
  };\n\nmock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody)\
  \ => {\n  if (typeof callback === 'function') {\n    callback(200);\n  } else {\n\
  \    requestBody = requestOptions;\n    requestOptions = callback;\n    return Promise.create((resolve,\
  \ reject) => {\n      resolve({ statusCode: 200 });\n    });  \n  }\n});\n\nmock('getRequestHeader',\
  \ (header) => {\n  if (header === 'trace-id') return 'expectedTraceId';\n});\n\n\
  mock('getTimestampMillis', 1747945830456);"


___NOTES___

Created on 28/07/2023, 16:50:17

